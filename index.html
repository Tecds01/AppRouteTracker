<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Control</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #F2F2F7;
            --ios-dark-gray: #1C1C1E;
            --ios-light-gray: #E5E5EA;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--ios-gray);
            color: var(--ios-dark-gray);
            line-height: 1.5;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            position: sticky;
            top: 0;
            background-color: var(--ios-gray);
            z-index: 10;
            border-bottom: 1px solid var(--ios-light-gray);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .tab-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px 0;
            border-top: 1px solid var(--ios-light-gray);
            z-index: 10;
        }
        
        .tab {
            text-align: center;
            padding: 8px 0;
            flex: 1;
            color: var(--ios-dark-gray);
            text-decoration: none;
            font-size: 12px;
        }
        
        .tab.active {
            color: var(--ios-blue);
        }
        
        .tab i {
            display: block;
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .section {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-title {
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid var(--ios-light-gray);
        }
        
        .form-group {
            padding: 15px;
            border-bottom: 1px solid var(--ios-light-gray);
        }
        
        .form-group:last-child {
            border-bottom: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--ios-light-gray);
            border-radius: 8px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: var(--ios-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button.secondary {
            background-color: var(--ios-light-gray);
            color: var(--ios-dark-gray);
        }
        
        button.danger {
            background-color: var(--ios-red);
        }
        
        button.success {
            background-color: var(--ios-green);
        }
        
        .client-container {
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--ios-gray);
            border-radius: 8px;
        }
        
        .time-display {
            font-size: 16px;
            margin-top: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            padding: 15px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 5px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
        }
        
        .calendar-day.active {
            background-color: var(--ios-blue);
            color: white;
        }
        
        .calendar-day.has-data {
            background-color: var(--ios-green);
            color: white;
        }
        
        .history-entry {
            padding: 15px;
            border-bottom: 1px solid var(--ios-light-gray);
        }
        
        .history-entry:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-clients {
            margin-left: 15px;
        }
        
        .history-client {
            margin-bottom: 5px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid var(--ios-light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .modal-footer {
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--ios-light-gray);
        }
        
        .modal-footer button {
            flex: 1;
        }
        
        .stats-container {
            padding: 15px;
        }
        
        .stat-item {
            margin-bottom: 15px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <h1 id="page-title">Rotas</h1>
    </header>
    
    <div class="container">
        <!-- Rotas Section -->
        <div id="routes-section">
            <div class="section">
                <div class="section-title">Nova Rota</div>
                <div class="form-group">
                    <label for="client-name">Nome do Cliente</label>
                    <input type="text" id="client-name" placeholder="Digite o nome do cliente">
                </div>
                <div class="form-group">
                    <label>Endereço</label>
                    <button id="get-location" class="secondary"><i class="fas fa-map-marker-alt"></i> Usar Localização Atual</button>
                    <div id="client-address" class="time-display">Endereço não definido</div>
                </div>
                
                <!-- Campos sempre visíveis -->
                <div class="form-group" id="arrival-group">
                    <label>Chegada ao Cliente</label>
                    <button id="arrival-time" class="secondary"><i class="fas fa-clock"></i> Registrar Chegada</button>
                    <div id="arrival-display" class="time-display">Não registrado</div>
                </div>
                
                <div class="form-group" id="departure-group">
                    <label>Saída do Cliente</label>
                    <button id="departure-time" class="secondary"><i class="fas fa-clock"></i> Registrar Saída</button>
                    <div id="departure-display" class="time-display">Não registrado</div>
                </div>
            </div>
            
            <div id="clients-container"></div>
            
            <div class="section">
                <div class="form-group">
                    <label>Volta à Oficina</label>
                    <button id="back-to-office" class="secondary"><i class="fas fa-home"></i> Registrar Retorno</button>
                    <div id="office-display" class="time-display">Não registrado</div>
                </div>
                <div class="form-group">
                    <label>Fim de Jornada</label>
                    <button id="end-of-day" class="secondary"><i class="fas fa-flag-checkered"></i> Registrar Fim</button>
                    <div id="end-display" class="time-display">Não registrado</div>
                </div>
                <div class="form-group">
                    <label>Almoço</label>
                    <div>
                        <button id="lunch-yes" class="secondary" style="width: 48%; display: inline-block;">Sim</button>
                        <button id="lunch-no" class="secondary" style="width: 48%; display: inline-block; margin-left: 4%;">Não</button>
                    </div>
                    <div id="lunch-display" class="time-display">Não definido</div>
                </div>
                <div class="form-group">
                    <label for="notes">Anotações</label>
                    <textarea id="notes" placeholder="Digite suas anotações aqui"></textarea>
                </div>
                <div class="form-group">
                    <button id="save-route" class="success"><i class="fas fa-save"></i> Salvar Rota</button>
                </div>
            </div>
        </div>
        
        <!-- Horas Section -->
        <div id="hours-section" class="hidden">
            <div class="section">
                <div class="section-title">Cálculo de Horas</div>
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-label">Horas de Hoje</div>
                        <div class="stat-value" id="today-hours">0h 0min</div>
                        <div class="stat-label" id="today-lunch-status"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Horas do Mês Atual</div>
                        <div class="stat-value" id="month-hours">0h 0min</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Exportar Relatório</div>
                <div class="form-group">
                    <label for="export-month">Selecione o Mês</label>
                    <select id="export-month">
                        <!-- Options will be filled by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <button id="export-pdf" class="secondary"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                </div>
            </div>
        </div>
        
        <!-- Histórico Section -->
        <div id="history-section" class="hidden">
            <div class="section">
                <div class="section-title">Calendário</div>
                <div id="calendar-container">
                    <!-- Calendar will be filled by JavaScript -->
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Dados do Dia</div>
                <div id="day-details">
                    <div style="padding: 15px; text-align: center; color: #666;">
                        Selecione um dia no calendário para visualizar os dados
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Exportar Histórico</div>
                <div class="form-group">
                    <label for="history-month">Selecione o Mês</label>
                    <select id="history-month">
                        <!-- Options will be filled by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <button id="export-history" class="secondary"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span id="edit-modal-title">Editar Cliente</span>
                <button id="close-edit-modal" style="background: none; border: none; color: var(--ios-blue); font-size: 16px; padding: 5px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="edit-modal-body">
                <!-- Content will be filled by JavaScript -->
            </div>
            <div class="modal-footer">
                <button id="cancel-edit" class="secondary">Cancelar</button>
                <button id="save-edit" class="success">Salvar</button>
            </div>
        </div>
    </div>
    
    <div class="tab-bar">
        <a href="#" class="tab active" id="routes-tab">
            <i class="fas fa-route"></i>
            <span>Rotas</span>
        </a>
        <a href="#" class="tab" id="hours-tab">
            <i class="fas fa-clock"></i>
            <span>Horas</span>
        </a>
        <a href="#" class="tab" id="history-tab">
            <i class="fas fa-history"></i>
            <span>Histórico</span>
        </a>
    </div>
    
    <script>
        // App State
        let currentRoute = {
            clients: [],
            officeArrival: null,
            endOfDay: null,
            lunch: null,
            notes: '',
            date: new Date().toISOString().split('T')[0]
        };
        
        let editingClientIndex = null;
        let selectedHistoryDate = null;
        
        // DOM Elements
        const routesSection = document.getElementById('routes-section');
        const hoursSection = document.getElementById('hours-section');
        const historySection = document.getElementById('history-section');
        
        const routesTab = document.getElementById('routes-tab');
        const hoursTab = document.getElementById('hours-tab');
        const historyTab = document.getElementById('history-tab');
        
        const pageTitle = document.getElementById('page-title');
        
        // Route Form Elements
        const clientNameInput = document.getElementById('client-name');
        const clientAddressDisplay = document.getElementById('client-address');
        const arrivalDisplay = document.getElementById('arrival-display');
        const departureDisplay = document.getElementById('departure-display');
        const officeDisplay = document.getElementById('office-display');
        const endDisplay = document.getElementById('end-display');
        const lunchDisplay = document.getElementById('lunch-display');
        const notesInput = document.getElementById('notes');
        const clientsContainer = document.getElementById('clients-container');
        
        // Buttons
        const getLocationBtn = document.getElementById('get-location');
        const arrivalTimeBtn = document.getElementById('arrival-time');
        const departureTimeBtn = document.getElementById('departure-time');
        const backToOfficeBtn = document.getElementById('back-to-office');
        const endOfDayBtn = document.getElementById('end-of-day');
        const lunchYesBtn = document.getElementById('lunch-yes');
        const lunchNoBtn = document.getElementById('lunch-no');
        const saveRouteBtn = document.getElementById('save-route');
        
        // Hours Section Elements
        const todayHoursDisplay = document.getElementById('today-hours');
        const todayLunchStatus = document.getElementById('today-lunch-status');
        const monthHoursDisplay = document.getElementById('month-hours');
        const exportMonthSelect = document.getElementById('export-month');
        const exportPdfBtn = document.getElementById('export-pdf');
        
        // History Section Elements
        const calendarContainer = document.getElementById('calendar-container');
        const dayDetails = document.getElementById('day-details');
        const historyMonthSelect = document.getElementById('history-month');
        const exportHistoryBtn = document.getElementById('export-history');
        
        // Modal Elements
        const editModal = document.getElementById('edit-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editModalBody = document.getElementById('edit-modal-body');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveEditBtn = document.getElementById('save-edit');
        
        // Initialize the app
        function init() {
            loadRoutes();
            setupEventListeners();
            updateUI();
            generateMonthSelectOptions();
            renderCalendar();
            calculateHours();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Tab navigation
            routesTab.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('routes');
            });
            
            hoursTab.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('hours');
                calculateHours();
            });
            
            historyTab.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('history');
            });
            
            // Route form buttons
            getLocationBtn.addEventListener('click', getCurrentLocation);
            arrivalTimeBtn.addEventListener('click', () => recordTime('arrival'));
            departureTimeBtn.addEventListener('click', () => recordTime('departure'));
            backToOfficeBtn.addEventListener('click', () => recordTime('office'));
            endOfDayBtn.addEventListener('click', () => recordTime('end'));
            
            lunchYesBtn.addEventListener('click', () => {
                currentRoute.lunch = true;
                lunchDisplay.textContent = 'Sim (será descontada 1 hora)';
                updateUI();
            });
            
            lunchNoBtn.addEventListener('click', () => {
                currentRoute.lunch = false;
                lunchDisplay.textContent = 'Não';
                updateUI();
            });
            
            saveRouteBtn.addEventListener('click', saveRoute);
            
            // History buttons
            exportPdfBtn.addEventListener('click', exportPdf);
            exportHistoryBtn.addEventListener('click', exportHistoryPdf);
            
            // Modal buttons
            closeEditModalBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);
            saveEditBtn.addEventListener('click', saveEditedClient);
        }
        
        // Show the selected section
        function showSection(section) {
            routesSection.classList.add('hidden');
            hoursSection.classList.add('hidden');
            historySection.classList.add('hidden');
            
            routesTab.classList.remove('active');
            hoursTab.classList.remove('active');
            historyTab.classList.remove('active');
            
            switch(section) {
                case 'routes':
                    routesSection.classList.remove('hidden');
                    routesTab.classList.add('active');
                    pageTitle.textContent = 'Rotas';
                    break;
                case 'hours':
                    hoursSection.classList.remove('hidden');
                    hoursTab.classList.add('active');
                    pageTitle.textContent = 'Horas';
                    break;
                case 'history':
                    historySection.classList.remove('hidden');
                    historyTab.classList.add('active');
                    pageTitle.textContent = 'Histórico';
                    break;
            }
        }
        
        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
                getLocationBtn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // In a real app, you would use a geocoding service here
                        // For demo purposes, we'll just display the coordinates
                        clientAddressDisplay.textContent = `Lat: ${latitude.toFixed(6)}, Long: ${longitude.toFixed(6)}`;
                        
                        getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Usar Localização Atual';
                        getLocationBtn.disabled = false;
                    },
                    (error) => {
                        alert('Erro ao obter localização: ' + error.message);
                        getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Usar Localização Atual';
                        getLocationBtn.disabled = false;
                    }
                );
            } else {
                alert('Geolocalização não é suportada pelo seu navegador.');
            }
        }
        
        // Record time for arrival, departure, office or end
        function recordTime(type) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            switch(type) {
                case 'arrival':
                    if (!clientNameInput.value.trim()) {
                        alert('Por favor, insira o nome do cliente primeiro.');
                        return;
                    }
                    
                    if (currentRoute.clients.length === 0 || currentRoute.clients[currentRoute.clients.length - 1].departure) {
                        // New client
                        currentRoute.clients.push({
                            name: clientNameInput.value.trim(),
                            address: clientAddressDisplay.textContent,
                            arrival: now.toISOString(),
                            departure: null
                        });
                        
                        clientNameInput.value = '';
                        clientAddressDisplay.textContent = 'Endereço não definido';
                    } else {
                        // Update last client's arrival
                        currentRoute.clients[currentRoute.clients.length - 1].arrival = now.toISOString();
                    }
                    
                    arrivalDisplay.textContent = timeString;
                    break;
                    
                case 'departure':
                    if (currentRoute.clients.length === 0) {
                        alert('Por favor, registre a chegada ao cliente primeiro.');
                        return;
                    }
                    
                    const lastClient = currentRoute.clients[currentRoute.clients.length - 1];
                    if (lastClient.departure) {
                        alert('A saída deste cliente já foi registrada.');
                        return;
                    }
                    
                    lastClient.departure = now.toISOString();
                    departureDisplay.textContent = timeString;
                    break;
                    
                case 'office':
                    currentRoute.officeArrival = now.toISOString();
                    officeDisplay.textContent = timeString;
                    break;
                    
                case 'end':
                    if (!currentRoute.officeArrival) {
                        alert('Por favor, registre o retorno à oficina primeiro.');
                        return;
                    }
                    
                    currentRoute.endOfDay = now.toISOString();
                    endDisplay.textContent = timeString;
                    break;
            }
            
            updateUI();
        }
        
        // Update the UI based on current state
        function updateUI() {
            // Update clients list
            clientsContainer.innerHTML = '';
            
            currentRoute.clients.forEach((client, index) => {
                const clientDiv = document.createElement('div');
                clientDiv.className = 'client-container';
                
                const arrivalTime = client.arrival ? new Date(client.arrival).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Não registrado';
                const departureTime = client.departure ? new Date(client.departure).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Não registrado';
                
                clientDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>${client.name}</h3>
                        <div>
                            <button class="edit-client" data-index="${index}" style="background: none; border: none; color: var(--ios-blue); padding: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-client" data-index="${index}" style="background: none; border: none; color: var(--ios-red); padding: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <div><strong>Endereço:</strong> ${client.address}</div>
                        <div><strong>Chegada:</strong> ${arrivalTime}</div>
                        <div><strong>Saída:</strong> ${departureTime}</div>
                    </div>
                `;
                
                clientsContainer.appendChild(clientDiv);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    editClient(index);
                });
            });
            
            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    deleteClient(index);
                });
            });
            
            // Enable/disable buttons based on state
            departureTimeBtn.disabled = currentRoute.clients.length === 0 || 
                                       !currentRoute.clients[currentRoute.clients.length - 1].arrival ||
                                       currentRoute.clients[currentRoute.clients.length - 1].departure;
            
            backToOfficeBtn.disabled = currentRoute.clients.length === 0 || 
                                     !currentRoute.clients[currentRoute.clients.length - 1].departure;
            
            endOfDayBtn.disabled = !currentRoute.officeArrival;
            
            saveRouteBtn.disabled = !currentRoute.endOfDay;
        }
        
        // Edit a client
        function editClient(index) {
            editingClientIndex = index;
            const client = currentRoute.clients[index];
            
            editModalTitle.textContent = `Editar ${client.name}`;
            
            const arrivalTime = client.arrival ? new Date(client.arrival).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const departureTime = client.departure ? new Date(client.departure).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            
            editModalBody.innerHTML = `
                <div class="form-group">
                    <label for="edit-client-name">Nome do Cliente</label>
                    <input type="text" id="edit-client-name" value="${client.name}">
                </div>
                <div class="form-group">
                    <label for="edit-client-address">Endereço</label>
                    <input type="text" id="edit-client-address" value="${client.address}">
                </div>
                <div class="form-group">
                    <label for="edit-arrival-time">Chegada</label>
                    <input type="time" id="edit-arrival-time" value="${arrivalTime}">
                </div>
                <div class="form-group">
                    <label for="edit-departure-time">Saída</label>
                    <input type="time" id="edit-departure-time" value="${departureTime}">
                </div>
            `;
            
            editModal.classList.remove('hidden');
        }
        
        // Save edited client
        function saveEditedClient() {
            const nameInput = document.getElementById('edit-client-name');
            const addressInput = document.getElementById('edit-client-address');
            const arrivalInput = document.getElementById('edit-arrival-time');
            const departureInput = document.getElementById('edit-departure-time');
            
            if (!nameInput.value.trim()) {
                alert('Por favor, insira o nome do cliente.');
                return;
            }
            
            const client = currentRoute.clients[editingClientIndex];
            client.name = nameInput.value.trim();
            client.address = addressInput.value.trim();
            
            // Update arrival time if changed
            if (arrivalInput.value) {
                const [hours, minutes] = arrivalInput.value.split(':');
                const arrivalDate = client.arrival ? new Date(client.arrival) : new Date();
                arrivalDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                client.arrival = arrivalDate.toISOString();
            }
            
            // Update departure time if changed
            if (departureInput.value) {
                const [hours, minutes] = departureInput.value.split(':');
                const departureDate = client.departure ? new Date(client.departure) : new Date();
                departureDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                client.departure = departureDate.toISOString();
            }
            
            closeEditModal();
            updateUI();
        }
        
        // Delete a client
        function deleteClient(index) {
            if (confirm('Tem certeza que deseja remover este cliente?')) {
                currentRoute.clients.splice(index, 1);
                updateUI();
            }
        }
        
        // Close edit modal
        function closeEditModal() {
            editModal.classList.add('hidden');
            editingClientIndex = null;
        }
        
        // Save the current route
        function saveRoute() {
            if (!currentRoute.endOfDay) {
                alert('Por favor, registre o fim da jornada antes de salvar.');
                return;
            }
            
            currentRoute.notes = notesInput.value.trim();
            
            // Get saved routes from localStorage
            let savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
            
            // Add current route
            savedRoutes.push(currentRoute);
            
            // Save back to localStorage
            localStorage.setItem('routes', JSON.stringify(savedRoutes));
            
            // Reset current route
            resetCurrentRoute();
            
            alert('Rota salva com sucesso!');
        }
        
        // Reset current route
        function resetCurrentRoute() {
            currentRoute = {
                clients: [],
                officeArrival: null,
                endOfDay: null,
                lunch: null,
                notes: '',
                date: new Date().toISOString().split('T')[0]
            };
            
            // Reset UI
            clientNameInput.value = '';
            clientAddressDisplay.textContent = 'Endereço não definido';
            arrivalDisplay.textContent = 'Não registrado';
            departureDisplay.textContent = 'Não registrado';
            officeDisplay.textContent = 'Não registrado';
            endDisplay.textContent = 'Não registrado';
            lunchDisplay.textContent = 'Não definido';
            notesInput.value = '';
            clientsContainer.innerHTML = '';
            
            updateUI();
        }
        
        // Load saved routes from localStorage
        function loadRoutes() {
            const savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
            // In a real app, you might want to do something with these
        }
        
        // Calculate hours worked
        function calculateHours() {
            const today = new Date().toISOString().split('T')[0];
            const savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
            
            // Calculate today's hours
            const todayRoute = savedRoutes.find(route => route.date === today);
            let todayHours = 0;
            let todayMinutes = 0;
            
            if (todayRoute && todayRoute.endOfDay && todayRoute.officeArrival) {
                const endTime = new Date(todayRoute.endOfDay);
                const officeTime = new Date(todayRoute.officeArrival);
                
                let diffMs = endTime - officeTime;
                
                // Subtract lunch time if applicable
                if (todayRoute.lunch) {
                    diffMs -= 3600000; // 1 hour in milliseconds
                }
                
                // Add time spent with clients
                todayRoute.clients.forEach(client => {
                    if (client.arrival && client.departure) {
                        const arrivalTime = new Date(client.arrival);
                        const departureTime = new Date(client.departure);
                        diffMs += departureTime - arrivalTime;
                    }
                });
                
                todayHours = Math.floor(diffMs / (1000 * 60 * 60));
                todayMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            }
            
            todayHoursDisplay.textContent = `${todayHours}h ${todayMinutes}min`;
            todayLunchStatus.textContent = todayRoute && todayRoute.lunch ? '(com desconto de 1h de almoço)' : '(sem almoço registrado)';
            
            // Calculate monthly hours (from 26th to 25th)
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            let startDate, endDate;
            
            if (now.getDate() >= 26) {
                // Current period is 26th of current month to 25th of next month
                startDate = new Date(currentYear, currentMonth, 26);
                endDate = new Date(currentYear, currentMonth + 1, 25);
            } else {
                // Current period is 26th of previous month to 25th of current month
                startDate = new Date(currentYear, currentMonth - 1, 26);
                endDate = new Date(currentYear, currentMonth, 25);
            }
            
            let totalMs = 0;
            let lunchCount = 0;
            
            savedRoutes.forEach(route => {
                const routeDate = new Date(route.date);
                
                if (routeDate >= startDate && routeDate <= endDate && route.endOfDay && route.officeArrival) {
                    const endTime = new Date(route.endOfDay);
                    const officeTime = new Date(route.officeArrival);
                    
                    let diffMs = endTime - officeTime;
                    
                    // Subtract lunch time if applicable
                    if (route.lunch) {
                        diffMs -= 3600000; // 1 hour in milliseconds
                        lunchCount++;
                    }
                    
                    // Add time spent with clients
                    route.clients.forEach(client => {
                        if (client.arrival && client.departure) {
                            const arrivalTime = new Date(client.arrival);
                            const departureTime = new Date(client.departure);
                            diffMs += departureTime - arrivalTime;
                        }
                    });
                    
                    totalMs += diffMs;
                }
            });
            
            const totalHours = Math.floor(totalMs / (1000 * 60 * 60));
            const totalMinutes = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));
            
            monthHoursDisplay.textContent = `${totalHours}h ${totalMinutes}min`;
        }
        
        // Generate month select options for export
        function generateMonthSelectOptions() {
            const savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
            if (savedRoutes.length === 0) return;
            
            // Get unique months from saved routes
            const months = new Set();
            
            savedRoutes.forEach(route => {
                const date = new Date(route.date);
                const month = date.getMonth();
                const year = date.getFullYear();
                months.add(`${year}-${month}`);
            });
            
            // Convert to array and sort
            const sortedMonths = Array.from(months).sort();
            
            // Clear and populate select elements
            exportMonthSelect.innerHTML = '';
            historyMonthSelect.innerHTML = '';
            
            sortedMonths.forEach(monthStr => {
                const [year, month] = monthStr.split('-');
                const monthName = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthStr;
                option.textContent = monthName;
                
                exportMonthSelect.appendChild(option.cloneNode(true));
                historyMonthSelect.appendChild(option);
            });
        }
        
        // Render calendar for history view
        function renderCalendar() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Get first day of month and total days in month
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Get saved routes
            const savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
            
            // Create calendar header
            let calendarHTML = '<div class="calendar-header">Dom</div>';
            calendarHTML += '<div class="calendar-header">Seg</div>';
            calendarHTML += '<div class="calendar-header">Ter</div>';
            calendarHTML += '<div class="calendar-header">Qua</div>';
            calendarHTML += '<div class="calendar-header">Qui</div>';
            calendarHTML += '<div class="calendar-header">Sex</div>';
            calendarHTML += '<div class="calendar-header">Sáb</div>';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasData = savedRoutes.some(route => route.date === dateStr);
                
                const isToday = now.getDate() === day && now.getMonth() === currentMonth && now.getFullYear() === currentYear;
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' active';
                if (hasData) dayClass += ' has-data';
                
                calendarHTML += `<div class="${dayClass}" data-date="${dateStr}">${day}</div>`;
            }
            
            calendarContainer.innerHTML = calendarHTML;
            
            // Add event listeners to calendar days
            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.addEventListener('click', () => {
                    const date = day.getAttribute('data-date');
                    showDayDetails(date);
                    selectedHistoryDate = date;
                    
                    // Update active day
                    document.querySelectorAll('.calendar-day').forEach(d => {
                        d.classList.remove('active');
                    });
                    day.classList.add('active');
                });
            });
            
            // Show today's details if available
            const todayStr = now.toISOString().split('T')[0];
            const todayRoute = savedRoutes.find(route => route.date === todayStr);
            if (todayRoute) {
                showDayDetails(todayStr);
                document.querySelector(`.calendar-day[data-date="${todayStr}"]`).classList.add('active');
            }
        }
        
        // Show details for a specific day
        function showDayDetails(date) {
            const savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
            const route = savedRoutes.find(r => r.date === date);
            
            if (!route) {
                dayDetails.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #666;">
                        Nenhum dado encontrado para este dia.
                    </div>
                `;
                return;
            }
            
            const dateObj = new Date(route.date);
            const formattedDate = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            let clientsHTML = '';
            route.clients.forEach(client => {
                const arrivalTime = client.arrival ? new Date(client.arrival).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Não registrado';
                const departureTime = client.departure ? new Date(client.departure).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Não registrado';
                
                clientsHTML += `
                    <div class="history-client">
                        <div><strong>${client.name}</strong></div>
                        <div>Endereço: ${client.address}</div>
                        <div>Chegada: ${arrivalTime} - Saída: ${departureTime}</div>
                    </div>
                `;
            });
            
            const officeTime = route.officeArrival ? new Date(route.officeArrival).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Não registrado';
            const endTime = route.endOfDay ? new Date(route.endOfDay).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Não registrado';
            const lunchStatus = route.lunch ? 'Sim (1h descontada)' : 'Não';
            
            dayDetails.innerHTML = `
                <div class="history-entry">
                    <div class="history-date">${formattedDate}</div>
                    <div class="history-clients">${clientsHTML || '<div>Nenhum cliente registrado</div>'}</div>
                </div>
                <div class="history-entry">
                    <div><strong>Retorno à oficina:</strong> ${officeTime}</div>
                    <div><strong>Fim de jornada:</strong> ${endTime}</div>
                    <div><strong>Almoço:</strong> ${lunchStatus}</div>
                </div>
                <div class="history-entry">
                    <div><strong>Anotações:</strong></div>
                    <div style="margin-top: 5px;">${route.notes || 'Nenhuma anotação'}</div>
                </div>
                <div class="form-group">
                    <button id="edit-day" class="secondary"><i class="fas fa-edit"></i> Editar Dia</button>
                </div>
            `;
            
            document.getElementById('edit-day').addEventListener('click', () => editDay(route));
        }
        
        // Edit a day's data
        function editDay(route) {
            editModalTitle.textContent = `Editar ${new Date(route.date).toLocaleDateString('pt-BR')}`;
            
            const officeTime = route.officeArrival ? new Date(route.officeArrival).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const endTime = route.endOfDay ? new Date(route.endOfDay).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            
            editModalBody.innerHTML = `
                <div class="form-group">
                    <label for="edit-office-time">Retorno à Oficina</label>
                    <input type="time" id="edit-office-time" value="${officeTime}">
                </div>
                <div class="form-group">
                    <label for="edit-end-time">Fim de Jornada</label>
                    <input type="time" id="edit-end-time" value="${endTime}">
                </div>
                <div class="form-group">
                    <label>Almoço</label>
                    <div>
                        <button id="edit-lunch-yes" class="${route.lunch ? 'success' : 'secondary'}" style="width: 48%; display: inline-block;">Sim</button>
                        <button id="edit-lunch-no" class="${!route.lunch ? 'danger' : 'secondary'}" style="width: 48%; display: inline-block; margin-left: 4%;">Não</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-notes">Anotações</label>
                    <textarea id="edit-notes">${route.notes || ''}</textarea>
                </div>
            `;
            
            // Add event listeners to lunch buttons
            document.getElementById('edit-lunch-yes').addEventListener('click', () => {
                document.getElementById('edit-lunch-yes').className = 'success';
                document.getElementById('edit-lunch-no').className = 'secondary';
            });
            
            document.getElementById('edit-lunch-no').addEventListener('click', () => {
                document.getElementById('edit-lunch-no').className = 'danger';
                document.getElementById('edit-lunch-yes').className = 'secondary';
            });
            
            editModal.classList.remove('hidden');
            
            // Override save button behavior for day editing
            saveEditBtn.onclick = function() {
                const officeTimeInput = document.getElementById('edit-office-time');
                const endTimeInput = document.getElementById('edit-end-time');
                const notesInput = document.getElementById('edit-notes');
                const lunchYes = document.getElementById('edit-lunch-yes').classList.contains('success');
                
                // Update office arrival time if changed
                if (officeTimeInput.value) {
                    const [hours, minutes] = officeTimeInput.value.split(':');
                    const officeDate = route.officeArrival ? new Date(route.officeArrival) : new Date(route.date);
                    officeDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    route.officeArrival = officeDate.toISOString();
                }
                
                // Update end time if changed
                if (endTimeInput.value) {
                    const [hours, minutes] = endTimeInput.value.split(':');
                    const endDate = route.endOfDay ? new Date(route.endOfDay) : new Date(route.date);
                    endDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    route.endOfDay = endDate.toISOString();
                }
                
                // Update lunch status
                route.lunch = lunchYes;
                
                // Update notes
                route.notes = notesInput.value.trim();
                
                // Save back to localStorage
                const savedRoutes = JSON.parse(localStorage.getItem('routes')) || [];
                const index = savedRoutes.findIndex(r => r.date === route.date);
                if (index !== -1) {
                    savedRoutes[index] = route;
                    localStorage.setItem('routes', JSON.stringify(savedRoutes));
                }
                
                closeEditModal();
                showDayDetails(route.date);
                calculateHours();
            };
        }
        
        // Export PDF (simulated - in a real app you would use a library like jsPDF)
        function exportPdf() {
            const monthStr = exportMonthSelect.value;
            if (!monthStr) {
                alert('Por favor, selecione um mês para exportar.');
                return;
            }
            
            const [year, month] = monthStr.split('-');
            const monthName = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            alert(`Simulação: Exportando relatório de horas para ${monthName} como PDF.\n\nEm uma implementação real, isso geraria um arquivo PDF com todos os dados do mês selecionado.`);
        }
        
        // Export history PDF (simulated)
        function exportHistoryPdf() {
            const monthStr = historyMonthSelect.value;
            if (!monthStr) {
                alert('Por favor, selecione um mês para exportar.');
                return;
            }
            
            const [year, month] = monthStr.split('-');
            const monthName = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            alert(`Simulação: Exportando histórico para ${monthName} como PDF.\n\nEm uma implementação real, isso geraria um arquivo PDF com todos os dados do mês selecionado.`);
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>