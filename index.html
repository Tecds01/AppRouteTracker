<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RouteTracker - Registro de Rotas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #007AFF;
            --secondary-color: #34C759;
            --danger-color: #FF3B30;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
            background-color: #f5f5f7;
        }
        .navbar {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.8);
        }
        .tab-content {
            padding: 15px;
        }
        .btn-ios {
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: 500;
            border: none;
        }
        .form-control, .form-select {
            border-radius: 10px;
            padding: 10px 15px;
            border: 1px solid #d1d1d6;
        }
        .time-entry {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .calendar-day {
            border: 1px solid #e5e5ea;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: white;
        }
        .calendar-day.active {
            background-color: var(--primary-color);
            color: white;
        }
        .calendar-day.has-data {
            background-color: #e8f4ff;
        }
        .nav-tabs {
            border-bottom: none;
            background: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .nav-tabs .nav-link {
            border: none;
            color: #8e8e93;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: transparent;
        }
        .tab-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        textarea {
            min-height: 100px;
            resize: none;
        }
        .notes-section {
            margin-top: 15px;
        }
        .period-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        .client-entry {
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 15px;
        }
        .location-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        .btn-group-vertical {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Barra de navegação -->
    <nav class="navbar navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">RouteTracker</span>
        </div>
    </nav>

    <!-- Conteúdo principal -->
    <div class="container mt-5">
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab">
                    <i class="fas fa-route tab-icon"></i>
                    <span>Rota</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hours-tab" data-bs-toggle="tab" data-bs-target="#hours" type="button" role="tab">
                    <i class="fas fa-clock tab-icon"></i>
                    <span>Horas</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                    <i class="fas fa-calendar-alt tab-icon"></i>
                    <span>Histórico</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Aba de Registro -->
            <div class="tab-pane fade show active" id="home" role="tabpanel">
                <div id="currentRouteForm">
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="clientName" placeholder="Nome do cliente">
                    </div>
                    
                    <div class="time-entry">
                        <h5><i class="fas fa-map-marked-alt me-2"></i>Registro de Tempos</h5>
                        <div class="mb-3">
                            <label class="form-label">Início da Jornada</label>
                            <div class="d-flex">
                                <input type="time" class="form-control me-2" id="startTime">
                                <button class="btn btn-outline-primary" onclick="getCurrentLocation('start')">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                            </div>
                            <div id="startLocation" class="location-info"></div>
                        </div>
                        
                        <div id="clientEntries">
                            <!-- Entradas de clientes serão adicionadas dinamicamente aqui -->
                        </div>
                        
                        <div class="mb-3" id="endTimeSection" style="display: none;">
                            <label class="form-label">Fim da Jornada</label>
                            <div class="d-flex">
                                <input type="time" class="form-control me-2" id="endTime">
                                <button class="btn btn-outline-primary" onclick="getCurrentLocation('end')">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                            </div>
                            <div id="endLocation" class="location-info"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Almoço?</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="lunchOption" id="lunchYes" value="yes" checked>
                                <label class="form-check-label" for="lunchYes">Sim (1h de almoço)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="lunchOption" id="lunchNo" value="no">
                                <label class="form-check-label" for="lunchNo">Não</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="time-entry notes-section">
                        <h5><i class="fas fa-edit me-2"></i>Anotações</h5>
                        <textarea class="form-control" id="routeNotes" placeholder="Adicione observações importantes sobre esta rota..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary btn-ios w-100 mt-3" onclick="saveRoute()">
                        <i class="fas fa-save me-2"></i>Salvar Rota
                    </button>
                    <button class="btn btn-outline-primary btn-ios w-100 mt-2" onclick="addClient()">
                        <i class="fas fa-plus me-2"></i>Adicionar Cliente
                    </button>
                </div>
                
                <div id="savedMessage" style="display: none;" class="alert alert-success mt-3">
                    Rota salva com sucesso! <a href="javascript:void(0)" onclick="startNewRoute()">Iniciar novo registro</a>
                </div>
            </div>

            <!-- Aba de Cálculo de Horas -->
            <div class="tab-pane fade" id="hours" role="tabpanel">
                <div class="mb-3">
                    <label for="selectedDate" class="form-label">Selecione a Data</label>
                    <input type="date" class="form-control" id="selectedDate" value="">
                </div>
                
                <div class="time-entry">
                    <h5><i class="fas fa-chart-pie me-2"></i>Resumo Diário</h5>
                    <div id="dailySummary">
                        <p class="text-muted">Nenhum registro encontrado para esta data.</p>
                    </div>
                </div>
                
                <div class="time-entry mt-3">
                    <h5><i class="fas fa-calendar-alt me-2"></i>Ciclo Mensal (26-25)</h5>
                    <div id="periodInfo" class="period-info"></div>
                    <div id="totalHours">
                        <p class="text-muted">0 horas</p>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-ios w-100 mt-3" onclick="exportData()">
                    <i class="fas fa-download me-2"></i>Exportar Relatório
                </button>
            </div>

            <!-- Aba de Histórico -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="mb-3">
                    <label for="monthSelector" class="form-label">Selecione o Mês</label>
                    <input type="month" class="form-control" id="monthSelector" value="">
                </div>
                
                <div id="calendar" class="mb-3 bg-white p-2 rounded-3 shadow-sm"></div>
                
                <div id="dayDetails" class="time-entry" style="display: none;">
                    <h5 id="detailDate"><i class="fas fa-calendar-day me-2"></i><span class="date-text"></span></h5>
                    <div id="detailContent" class="mt-3"></div>
                    <button class="btn btn-outline-primary btn-ios mt-3" onclick="editEntry()">
                        <i class="fas fa-edit me-2"></i>Editar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- Conteúdo dinâmico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedEntry()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Próximo Cliente -->
    <div class="modal fade" id="nextClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Próximo Passo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O que você deseja fazer após sair deste cliente?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="addAnotherClient()">Ir para outro cliente</button>
                    <button type="button" class="btn btn-secondary" onclick="returnToOffice()">Voltar para oficina</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Variáveis globais
        let currentRoute = {
            date: '',
            clientName: '',
            startTime: '',
            endTime: '',
            lunch: true,
            notes: '',
            locations: {},
            clients: []
        };
        
        let currentClient = {
            name: '',
            arrivalTime: '',
            departureTime: '',
            arrivalLocation: null,
            departureLocation: null
        };
        
        let isNewRoute = true;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Definir data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectedDate').value = today;
            document.getElementById('monthSelector').value = today.substr(0, 7);
            currentRoute.date = today;
            
            // Carregar calendário
            generateCalendar();
            
            // Verificar se há dados salvos
            if (!localStorage.getItem('routes')) {
                localStorage.setItem('routes', JSON.stringify([]));
            }
            
            // Carregar rascunho se existir
            loadDraft();
            
            // Atualizar horas do período
            updateMonthlyHours();
            
            // Carregar resumo diário
            loadDailySummary();
            
            // Adicionar evento de mudança para a data selecionada
            document.getElementById('selectedDate').addEventListener('change', loadDailySummary);
            document.getElementById('monthSelector').addEventListener('change', generateCalendar);
        });

        // Carregar rascunho não salvo
        function loadDraft() {
            const draft = localStorage.getItem('currentRouteDraft');
            if (draft) {
                const parsedDraft = JSON.parse(draft);
                currentRoute = parsedDraft.route;
                currentClient = parsedDraft.client || {
                    name: '',
                    arrivalTime: '',
                    departureTime: '',
                    arrivalLocation: null,
                    departureLocation: null
                };
                
                // Preencher formulário
                document.getElementById('clientName').value = currentRoute.clientName || '';
                document.getElementById('startTime').value = currentRoute.startTime || '';
                document.getElementById('routeNotes').value = currentRoute.notes || '';
                document.getElementById('lunchYes').checked = currentRoute.lunch !== false;
                document.getElementById('lunchNo').checked = currentRoute.lunch === false;
                
                // Exibir localizações
                if (currentRoute.locations.start) {
                    displayLocation('start', currentRoute.locations.start);
                }
                
                // Recriar entradas de clientes
                currentRoute.clients.forEach((client, index) => {
                    addClientEntry(client, index);
                    
                    if (client.arrivalLocation) {
                        displayLocation(`arrival-${index}`, client.arrivalLocation);
                    }
                    
                    if (client.departureLocation) {
                        displayLocation(`departure-${index}`, client.departureLocation);
                    }
                });
                
                // Se já tiver clientes, mostrar seção de fim de jornada
                if (currentRoute.clients.length > 0) {
                    document.getElementById('endTimeSection').style.display = 'block';
                    document.getElementById('endTime').value = currentRoute.endTime || '';
                    
                    if (currentRoute.locations.end) {
                        displayLocation('end', currentRoute.locations.end);
                    }
                }
                
                isNewRoute = false;
            }
        }

        // Salvar rascunho localmente
        function saveDraft() {
            // Atualizar dados atuais
            currentRoute.clientName = document.getElementById('clientName').value;
            currentRoute.startTime = document.getElementById('startTime').value;
            currentRoute.endTime = document.getElementById('endTime').value;
            currentRoute.notes = document.getElementById('routeNotes').value;
            currentRoute.lunch = document.getElementById('lunchYes').checked;
            
            const draft = {
                route: currentRoute,
                client: currentClient
            };
            
            localStorage.setItem('currentRouteDraft', JSON.stringify(draft));
        }

        // Adicionar cliente manualmente
        function addClient() {
            // Se for o primeiro cliente, mostrar seção de fim de jornada
            if (currentRoute.clients.length === 0) {
                document.getElementById('endTimeSection').style.display = 'block';
            }
            
            // Adicionar nova entrada de cliente
            addClientEntry(currentClient, currentRoute.clients.length);
            
            // Salvar rascunho
            saveDraft();
        }

        // Obter localização atual
        function getCurrentLocation(stage) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const now = new Date();
                        const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                                         now.getMinutes().toString().padStart(2, '0');
                        
                        // Atualizar o campo de tempo correspondente
                        if (stage === 'start') {
                            document.getElementById('startTime').value = timeString;
                        } else if (stage === 'end') {
                            document.getElementById('endTime').value = timeString;
                        } else if (stage.startsWith('arrival')) {
                            const clientIndex = stage.split('-')[1] || currentRoute.clients.length;
                            document.getElementById(`arrivalTime-${clientIndex}`).value = timeString;
                        } else if (stage.startsWith('departure')) {
                            const clientIndex = stage.split('-')[1] || currentRoute.clients.length;
                            document.getElementById(`departureTime-${clientIndex}`).value = timeString;
                        }
                        
                        // Armazenar localização
                        const locationData = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            timestamp: now.getTime()
                        };
                        
                        if (stage === 'start') {
                            currentRoute.locations.start = locationData;
                        } else if (stage === 'end') {
                            currentRoute.locations.end = locationData;
                        } else if (stage.startsWith('arrival')) {
                            const clientIndex = stage.split('-')[1] || currentRoute.clients.length;
                            if (!currentRoute.clients[clientIndex]) {
                                currentRoute.clients[clientIndex] = {
                                    name: '',
                                    arrivalTime: '',
                                    departureTime: '',
                                    arrivalLocation: null,
                                    departureLocation: null
                                };
                            }
                            currentRoute.clients[clientIndex].arrivalLocation = locationData;
                        } else if (stage.startsWith('departure')) {
                            const clientIndex = stage.split('-')[1] || currentRoute.clients.length;
                            if (!currentRoute.clients[clientIndex]) {
                                currentRoute.clients[clientIndex] = {
                                    name: '',
                                    arrivalTime: '',
                                    departureTime: '',
                                    arrivalLocation: null,
                                    departureLocation: null
                                };
                            }
                            currentRoute.clients[clientIndex].departureLocation = locationData;
                        }
                        
                        // Exibir localização
                        displayLocation(stage, locationData);
                        
                        // Salvar rascunho
                        saveDraft();
                    },
                    (error) => {
                        alert('Erro ao obter localização: ' + error.message);
                    }
                );
            } else {
                alert('Geolocalização não suportada pelo navegador');
            }
        }

        // Exibir localização no formulário
        function displayLocation(stage, locationData) {
            // Obter endereço aproximado (simplificado)
            let locationText = `Lat: ${locationData.lat.toFixed(6)}, Long: ${locationData.lng.toFixed(6)}`;
            
            // Tentar obter endereço (usando API Nominatim - OpenStreetMap)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${locationData.lat}&lon=${locationData.lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.address) {
                        const address = [];
                        if (data.address.road) address.push(data.address.road);
                        if (data.address.suburb) address.push(data.address.suburb);
                        if (data.address.city) address.push(data.address.city);
                        locationText = address.join(', ');
                    }
                })
                .catch(() => {
                    // Se falhar, mantém as coordenadas
                })
                .finally(() => {
                    // Atualizar exibição
                    if (stage === 'start') {
                        document.getElementById('startLocation').textContent = locationText;
                    } else if (stage === 'end') {
                        document.getElementById('endLocation').textContent = locationText;
                    } else if (stage.startsWith('arrival')) {
                        const clientIndex = stage.split('-')[1];
                        const locationElement = document.getElementById(`arrivalLocation-${clientIndex}`);
                        if (locationElement) {
                            locationElement.textContent = locationText;
                        }
                    } else if (stage.startsWith('departure')) {
                        const clientIndex = stage.split('-')[1];
                        const locationElement = document.getElementById(`departureLocation-${clientIndex}`);
                        if (locationElement) {
                            locationElement.textContent = locationText;
                        }
                    }
                });
        }

        // Adicionar entrada de cliente
        function addClientEntry(clientData, index) {
            const clientEntry = document.createElement('div');
            clientEntry.className = 'client-entry';
            clientEntry.id = `clientEntry-${index}`;
            
            clientEntry.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Cliente ${index + 1}</label>
                    <input type="text" class="form-control client-name" value="${clientData.name || ''}" 
                           placeholder="Nome do cliente" onchange="updateClientName(${index}, this.value)">
                </div>
                <div class="mb-3">
                    <label class="form-label">Chegada no Cliente</label>
                    <div class="d-flex">
                        <input type="time" class="form-control me-2 arrival-time" id="arrivalTime-${index}" 
                               value="${clientData.arrivalTime || ''}" onchange="updateClientArrivalTime(${index}, this.value)">
                        <button class="btn btn-outline-primary" onclick="getCurrentLocation('arrival-${index}')">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                    <div id="arrivalLocation-${index}" class="location-info"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Saída do Cliente</label>
                    <div class="d-flex">
                        <input type="time" class="form-control me-2 departure-time" id="departureTime-${index}" 
                               value="${clientData.departureTime || ''}" onchange="updateClientDepartureTime(${index}, this.value)">
                        <button class="btn btn-outline-primary" onclick="getCurrentLocation('departure-${index}')">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                    <div id="departureLocation-${index}" class="location-info"></div>
                </div>
            `;
            
            document.getElementById('clientEntries').appendChild(clientEntry);
        }

        // Atualizar nome do cliente
        function updateClientName(index, value) {
            if (!currentRoute.clients[index]) {
                currentRoute.clients[index] = {
                    name: '',
                    arrivalTime: '',
                    departureTime: '',
                    arrivalLocation: null,
                    departureLocation: null
                };
            }
            currentRoute.clients[index].name = value;
            saveDraft();
        }

        // Atualizar hora de chegada do cliente
        function updateClientArrivalTime(index, value) {
            if (!currentRoute.clients[index]) {
                currentRoute.clients[index] = {
                    name: '',
                    arrivalTime: '',
                    departureTime: '',
                    arrivalLocation: null,
                    departureLocation: null
                };
            }
            currentRoute.clients[index].arrivalTime = value;
            saveDraft();
        }

        // Atualizar hora de saída do cliente
        function updateClientDepartureTime(index, value) {
            if (!currentRoute.clients[index]) {
                currentRoute.clients[index] = {
                    name: '',
                    arrivalTime: '',
                    departureTime: '',
                    arrivalLocation: null,
                    departureLocation: null
                };
            }
            currentRoute.clients[index].departureTime = value;
            saveDraft();
            
            // Mostrar modal de confirmação para próximo passo
            const nextClientModal = new bootstrap.Modal(document.getElementById('nextClientModal'));
            nextClientModal.show();
        }

        // Adicionar outro cliente
        function addAnotherClient() {
            // Salvar dados do cliente atual
            const currentIndex = currentRoute.clients.length;
            currentRoute.clients.push({
                ...currentClient,
                name: document.querySelector(`#clientEntry-${currentIndex} .client-name`).value,
                arrivalTime: document.querySelector(`#clientEntry-${currentIndex} .arrival-time`).value,
                departureTime: document.querySelector(`#clientEntry-${currentIndex} .departure-time`).value
            });
            
            // Resetar cliente atual
            currentClient = {
                name: '',
                arrivalTime: '',
                departureTime: '',
                arrivalLocation: null,
                departureLocation: null
            };
            
            // Adicionar nova entrada de cliente
            addClientEntry(currentClient, currentRoute.clients.length);
            
            // Salvar rascunho
            saveDraft();
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('nextClientModal')).hide();
        }

        // Voltar para oficina (finalizar jornada)
        function returnToOffice() {
            // Salvar dados do cliente atual
            const currentIndex = currentRoute.clients.length;
            currentRoute.clients.push({
                ...currentClient,
                name: document.querySelector(`#clientEntry-${currentIndex} .client-name`).value,
                arrivalTime: document.querySelector(`#clientEntry-${currentIndex} .arrival-time`).value,
                departureTime: document.querySelector(`#clientEntry-${currentIndex} .departure-time`).value
            });
            
            // Salvar rascunho
            saveDraft();
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('nextClientModal')).hide();
            
            // Focar no campo de fim de jornada
            document.getElementById('endTime').focus();
        }

        // Salvar rota completa
        function saveRoute() {
            // Verificar se todos os campos obrigatórios estão preenchidos
            if (!document.getElementById('startTime').value || 
                (currentRoute.clients.length === 0 && !document.getElementById('clientName').value) || 
                !document.getElementById('endTime').value) {
                alert('Preencha todos os campos obrigatórios');
                return;
            }
            
            // Atualizar dados da rota
            currentRoute.clientName = document.getElementById('clientName').value;
            currentRoute.startTime = document.getElementById('startTime').value;
            currentRoute.endTime = document.getElementById('endTime').value;
            currentRoute.notes = document.getElementById('routeNotes').value;
            currentRoute.lunch = document.getElementById('lunchYes').checked;
            
            // Salvar no localStorage
            const routes = JSON.parse(localStorage.getItem('routes')) || [];
            
            // Verificar se já existe registro para hoje
            const existingIndex = routes.findIndex(route => route.date === currentRoute.date);
            
            if (existingIndex !== -1) {
                if (!confirm('Já existe um registro para hoje. Deseja substituí-lo?')) {
                    return;
                }
                routes.splice(existingIndex, 1);
            }
            
            routes.push(currentRoute);
            localStorage.setItem('routes', JSON.stringify(routes));
            
            // Limpar rascunho
            localStorage.removeItem('currentRouteDraft');
            
            // Mostrar mensagem de sucesso
            document.getElementById('currentRouteForm').style.display = 'none';
            document.getElementById('savedMessage').style.display = 'block';
            
            // Atualizar histórico e cálculos
            generateCalendar();
            updateMonthlyHours();
            loadDailySummary();
        }

        // Iniciar novo registro
        function startNewRoute() {
            // Resetar dados
            currentRoute = {
                date: new Date().toISOString().split('T')[0],
                clientName: '',
                startTime: '',
                endTime: '',
                lunch: true,
                notes: '',
                locations: {},
                clients: []
            };
            
            currentClient = {
                name: '',
                arrivalTime: '',
                departureTime: '',
                arrivalLocation: null,
                departureLocation: null
            };
            
            // Resetar formulário
            document.getElementById('clientName').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('routeNotes').value = '';
            document.getElementById('lunchYes').checked = true;
            document.getElementById('lunchNo').checked = false;
            document.getElementById('startLocation').textContent = '';
            document.getElementById('endLocation').textContent = '';
            document.getElementById('clientEntries').innerHTML = '';
            document.getElementById('endTimeSection').style.display = 'none';
            
            // Mostrar formulário e esconder mensagem
            document.getElementById('currentRouteForm').style.display = 'block';
            document.getElementById('savedMessage').style.display = 'none';
            
            isNewRoute = true;
        }

        // Carregar resumo diário
        function loadDailySummary() {
            const selectedDate = document.getElementById('selectedDate').value;
            const routes = JSON.parse(localStorage.getItem('routes')) || [];
            const dayRoute = routes.find(route => route.date === selectedDate);
            
            if (!dayRoute) {
                document.getElementById('dailySummary').innerHTML = '<p class="text-muted">Nenhum registro encontrado para esta data.</p>';
                return;
            }
            
            let summaryHTML = `
                <p><strong>Cliente Principal:</strong> ${dayRoute.clientName || 'Não informado'}</p>
                <p><strong>Início:</strong> ${dayRoute.startTime}</p>
                <p><strong>Fim:</strong> ${dayRoute.endTime}</p>
                <p><strong>Almoço:</strong> ${dayRoute.lunch ? 'Sim (1h)' : 'Não'}</p>
            `;
            
            if (dayRoute.clients && dayRoute.clients.length > 0) {
                summaryHTML += `<p><strong>Clientes Visitados:</strong> ${dayRoute.clients.length}</p>`;
            }
            
            document.getElementById('dailySummary').innerHTML = summaryHTML;
        }

        // Função para calcular horas entre dias 26-25
        function calculateMonthlyHours() {
            const routes = JSON.parse(localStorage.getItem('routes')) || [];
            if (routes.length === 0) return { totalHours: 0, totalMinutes: 0, period: '', daysCount: 0 };

            // Encontrar o período atual (do dia 26 ao dia 25)
            const today = new Date();
            let startDate, endDate;

            if (today.getDate() >= 26) {
                // Período atual: dia 26 deste mês até dia 25 do próximo mês
                startDate = new Date(today.getFullYear(), today.getMonth(), 26);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 25);
            } else {
                // Período atual: dia 26 do mês passado até dia 25 deste mês
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 26);
                endDate = new Date(today.getFullYear(), today.getMonth(), 25);
            }

            // Filtrar rotas dentro do período
            const periodRoutes = routes.filter(route => {
                const routeDate = new Date(route.date);
                return routeDate >= startDate && routeDate <= endDate;
            });

            // Calcular o total de horas
            let totalMs = 0;

            periodRoutes.forEach(route => {
                const start = new Date(`${route.date}T${route.startTime}`);
                const end = new Date(`${route.date}T${route.endTime}`);
                totalMs += (end - start);

                // Subtrair 1h se almoçou
                if (route.lunch) {
                    totalMs -= 3600000; // 1h em milissegundos
                }
            });

            const totalHours = Math.floor(totalMs / 3600000);
            const totalMinutes = Math.floor((totalMs % 3600000) / 60000);

            return {
                totalHours,
                totalMinutes,
                period: `${formatDate(startDate)} a ${formatDate(endDate)}`,
                daysCount: periodRoutes.length
            };
        }

        // Atualizar exibição das horas mensais
        function updateMonthlyHours() {
            const monthlyHours = calculateMonthlyHours();
            document.getElementById('periodInfo').textContent = `Período: ${monthlyHours.period} (${monthlyHours.daysCount} dias registrados)`;
            document.getElementById('totalHours').innerHTML = `
                <p><strong>Total acumulado:</strong> ${monthlyHours.totalHours}h ${monthlyHours.totalMinutes}m</p>
            `;
        }

        // Formatar data para exibição
        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Gerar calendário
        function generateCalendar() {
            const monthSelector = document.getElementById('monthSelector').value;
            const [year, month] = monthSelector.split('-');
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            const routes = JSON.parse(localStorage.getItem('routes')) || [];
            const monthRoutes = routes.filter(route => route.date.startsWith(monthSelector));
            
            let calendarHTML = '<div class="row">';
            
            // Cabeçalho com dias da semana
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            weekdays.forEach(day => {
                calendarHTML += `<div class="col text-center fw-bold">${day}</div>`;
            });
            
            calendarHTML += '</div><div class="row">';
            
            // Dias vazios no início do mês
            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarHTML += '<div class="col calendar-day"></div>';
            }
            
            // Dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '