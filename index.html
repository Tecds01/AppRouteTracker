<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Route Tracker</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --secondary-color: #34C759;
            --orange-color: #FF9500;
            --red-color: #FF3B30;
            --black-color: #000000;
            --background-color: #F2F2F7;
            --card-color: #FFFFFF;
            --text-color: #1C1C1E;
            --secondary-text: #8E8E93;
            --border-color: #D1D1D6;
            --gps-color: #000000;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding-bottom: 80px;
            -webkit-text-size-adjust: 100%;
        }
        
        header {
            background-color: var(--card-color);
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        
        .date-display {
            font-size: 14px;
            color: var(--secondary-text);
            margin-top: 4px;
        }
        
        .tabs {
            display: flex;
            background-color: var(--card-color);
            position: sticky;
            top: 60px;
            z-index: 9;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: var(--secondary-text);
            font-weight: 500;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .container {
            padding: 15px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 3px solid var(--primary-color);
        }
        
        /* Rotas Tab Styles */
        .checkpoint {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .checkpoint-time {
            min-width: 90px;
            font-weight: 500;
            padding-top: 2px;
        }
        
        .checkpoint-time input {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 14px;
            width: 100%;
        }
        
        .checkpoint-details {
            flex: 1;
            padding-left: 10px;
        }
        
        .checkpoint-type {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .checkpoint-address {
            color: var(--secondary-text);
            font-size: 13px;
            line-height: 1.4;
            margin-top: 5px;
        }
        
        .gps-btn {
            background-color: transparent;
            color: var(--gps-color);
            border: none;
            font-size: 18px;
            margin-left: 5px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .gps-btn::after {
            content: "üìç";
        }
        
        .client-info-block {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        
        .client-field {
            margin-bottom: 12px;
        }
        
        .client-field label {
            display: block;
            font-size: 13px;
            color: var(--secondary-text);
            margin-bottom: 4px;
        }
        
        .client-field input,
        .client-field textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .client-field textarea {
            min-height: 70px;
            resize: vertical;
        }
        
        .remove-client {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--red-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .lunch-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 15px;
            margin: 15px 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--secondary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .action-buttons {
            margin-top: 20px;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            text-align: center;
        }
        
        .button.secondary {
            background-color: var(--black-color);
            margin-top: 10px;
        }
        
        .button.tertiary {
            background-color: var(--orange-color);
            margin-top: 10px;
        }
        
        /* Horas Tab Styles */
        .day-selector {
            display: flex;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .day-selector label {
            margin-right: 10px;
            font-weight: 500;
        }
        
        .day-selector select {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .day-summary {
            background-color: var(--card-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .day-total {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .lunch-status {
            font-size: 14px;
            color: var(--secondary-text);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        
        .stat-card {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--secondary-text);
        }
        
        .monthly-summary {
            margin-top: 25px;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .summary-table th {
            text-align: left;
            padding: 8px;
            font-weight: 500;
            color: var(--secondary-text);
            border-bottom: 1px solid var(--border-color);
        }
        
        .summary-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .hidden {
            display: none;
        }
        
        /* Hist√≥rico Tab Styles */
        .history-day-selector {
            margin-bottom: 15px;
        }
        
        .history-day-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .history-details {
            background-color: var(--card-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .history-date-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-delete-btn {
            background-color: var(--red-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .history-client {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-client:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .history-client-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .history-client-info {
            font-size: 13px;
            color: var(--secondary-text);
            margin-bottom: 5px;
        }
        
        .history-client-notes {
            font-size: 13px;
            margin-top: 10px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 6px;
        }
        
        .history-checkpoint {
            display: flex;
            margin: 10px 0;
        }
        
        .history-checkpoint-time {
            min-width: 70px;
            font-weight: 500;
        }
        
        .history-checkpoint-details {
            flex: 1;
        }
        
        .history-checkpoint-address {
            font-size: 13px;
            color: var(--secondary-text);
        }
        
        .history-edit-btn {
            background-color: var(--orange-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
            width: 100%;
        }
        
        .no-history {
            text-align: center;
            color: var(--secondary-text);
            padding: 20px 0;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal {
            background-color: var(--card-color);
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .modal-message {
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-button {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .modal-button.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .modal-button.secondary {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        
        .modal-button.danger {
            background-color: var(--red-color);
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <h1>Route Tracker</h1>
        <div class="date-display">quinta-feira, 27 de mar√ßo de 2025</div>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="routes">Rotas</div>
        <div class="tab" data-tab="hours">Horas</div>
        <div class="tab" data-tab="history">Hist√≥rico</div>
    </div>
    
    <!-- Rotas Tab -->
    <div id="routes-tab" class="container">
        <div class="section">
            <div class="section-title">Checkpoints da Rota</div>
            
            <div class="checkpoint">
                <div class="checkpoint-time">
                    <input type="time" id="start-time" value="08:00">
                </div>
                <div class="checkpoint-details">
                    <div class="checkpoint-type">In√≠cio
                        <button class="gps-btn" onclick="getGPSLocation('start-time', 'start-address')"></button>
                    </div>
                    <div class="checkpoint-address" id="start-address"></div>
                </div>
            </div>
            
            <div id="client-blocks">
                <!-- Client blocks will be added here dynamically -->
            </div>
            
            <button class="button secondary" id="add-client-btn">+ Adicionar Cliente</button>
            
            <div class="checkpoint">
                <div class="checkpoint-time">
                    <input type="time" id="end-time" value="17:00">
                </div>
                <div class="checkpoint-details">
                    <div class="checkpoint-type">Fim
                        <button class="gps-btn" onclick="getGPSLocation('end-time', 'end-address')"></button>
                    </div>
                    <div class="checkpoint-address" id="end-address"></div>
                </div>
            </div>
        </div>
        
        <div class="lunch-toggle">
            <div>Fez pausa para almo√ßo?</div>
            <label class="toggle-switch">
                <input type="checkbox" id="lunch-toggle">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="action-buttons">
            <button class="button" id="save-btn">SALVAR</button>
        </div>
    </div>
    
    <!-- Horas Tab -->
    <div id="hours-tab" class="container hidden">
        <div class="day-selector">
            <label>Selecione o dia:</label>
            <select id="day-select">
                <!-- Options will be populated dynamically -->
            </select>
        </div>
        
        <div id="day-summary-container">
            <!-- Day summary will be populated dynamically -->
        </div>
        
        <div id="stats-container">
            <!-- Statistics will be populated dynamically -->
        </div>
        
        <div class="monthly-summary">
            <div class="section-title">Total Mensal</div>
            <div class="day-total" id="monthly-total">0h 00m</div>
            
            <table class="summary-table" id="monthly-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Horas</th>
                        <th>Almo√ßo</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Hist√≥rico Tab -->
    <div id="history-tab" class="container hidden">
        <div class="section">
            <div class="section-title">Hist√≥rico de Rotas</div>
            
            <div class="history-day-selector">
                <select id="history-day-select">
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div id="history-details-container">
                <!-- History details will be populated dynamically -->
            </div>
        </div>
    </div>
    
    <script>
        // App state
        const appState = {
            routes: JSON.parse(localStorage.getItem('routes')) || [],
            currentRoute: {
                date: new Date(),
                startTime: '08:00',
                endTime: '17:00',
                lunchBreak: false,
                clients: [],
                startAddress: '',
                endAddress: '',
                workedHours: 0
            },
            editingRoute: null
        };
        
        // Client block template
        const clientBlockTemplate = `
        <div class="client-block">
            <div class="checkpoint">
                <div class="checkpoint-time">
                    <input type="time" class="client-arrival-time" value="10:00">
                </div>
                <div class="checkpoint-details">
                    <div class="checkpoint-type">Chegada no Cliente
                        <button class="gps-btn" onclick="getGPSLocation(this, 'arrival')"></button>
                    </div>
                    <div class="checkpoint-address client-arrival-address"></div>
                </div>
            </div>
            
            <div class="client-info-block">
                <button class="remove-client" onclick="removeClientBlock(this)">√ó</button>
                <div class="client-field">
                    <label>Nome do Cliente</label>
                    <input type="text" class="client-name" placeholder="Digite o nome">
                </div>
                <div class="client-field">
                    <label>Endere√ßo do Cliente</label>
                    <input type="text" class="client-address" placeholder="Digite o endere√ßo">
                </div>
                <div class="client-field">
                    <label>Notas do Servi√ßo</label>
                    <textarea class="service-notes" placeholder="Adicione notas"></textarea>
                </div>
            </div>
            
            <div class="checkpoint">
                <div class="checkpoint-time">
                    <input type="time" class="client-departure-time" value="11:00">
                </div>
                <div class="checkpoint-details">
                    <div class="checkpoint-type">Sa√≠da do Cliente
                        <button class="gps-btn" onclick="getGPSLocation(this, 'departure')"></button>
                    </div>
                    <div class="checkpoint-address client-departure-address"></div>
                </div>
            </div>
        </div>
        `;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName, e);
                });
            });
            
            // Add first client block
            addClientBlock();
            
            // Add event listeners
            document.getElementById('add-client-btn').addEventListener('click', addClientBlock);
            document.getElementById('save-btn').addEventListener('click', saveRoute);
            document.getElementById('lunch-toggle').addEventListener('change', function() {
                appState.currentRoute.lunchBreak = this.checked;
            });
            document.getElementById('day-select').addEventListener('change', updateDaySummary);
            document.getElementById('history-day-select').addEventListener('change', showHistoryDetails);
            
            // Initialize time inputs
            document.getElementById('start-time').addEventListener('change', function() {
                appState.currentRoute.startTime = this.value;
            });
            
            document.getElementById('end-time').addEventListener('change', function() {
                appState.currentRoute.endTime = this.value;
            });
            
            // Update current date
            updateCurrentDate();
            
            // Load history
            loadHistory();
        });
        
        // Show/hide tabs
        function showTab(tabName, event) {
            // Hide all tabs
            document.getElementById('routes-tab').classList.add('hidden');
            document.getElementById('hours-tab').classList.add('hidden');
            document.getElementById('history-tab').classList.add('hidden');
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected tab
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // If showing hours tab, update data
            if (tabName === 'hours') {
                updateHoursTab();
            }
            
            // If showing history tab, refresh list
            if (tabName === 'history') {
                loadHistory();
            }
        }
        
        // Add a new client block
        function addClientBlock() {
            const clientBlocks = document.getElementById('client-blocks');
            const newBlock = document.createElement('div');
            newBlock.innerHTML = clientBlockTemplate;
            clientBlocks.appendChild(newBlock);
            
            // Add to current route
            appState.currentRoute.clients.push({
                arrivalTime: '10:00',
                departureTime: '11:00',
                name: '',
                address: '',
                notes: '',
                arrivalAddress: '',
                departureAddress: ''
            });
        }
        
        // Remove a client block
        function removeClientBlock(button) {
            const clientBlock = button.closest('.client-block');
            const index = Array.from(document.querySelectorAll('.client-block')).indexOf(clientBlock);
            
            if (document.querySelectorAll('.client-block').length > 1) {
                clientBlock.remove();
                if (appState.editingRoute) {
                    appState.editingRoute.clients.splice(index, 1);
                } else {
                    appState.currentRoute.clients.splice(index, 1);
                }
            } else {
                alert("Voc√™ precisa ter pelo menos um cliente cadastrado.");
            }
        }
        
        // Simulate GPS location
        function getGPSLocation(element, type = null) {
            // This is a simulation - in a real app, you would use:
            // navigator.geolocation.getCurrentPosition()
            
            let timeInput, addressElement;
            
            if (typeof element === 'string') {
                // If element is an ID
                timeInput = document.getElementById(element);
                addressElement = document.getElementById(type);
                
                // Update app state
                if (element === 'start-time') {
                    if (appState.editingRoute) {
                        appState.editingRoute.startAddress = "Localiza√ß√£o via GPS";
                    } else {
                        appState.currentRoute.startAddress = "Localiza√ß√£o via GPS";
                    }
                } else if (element === 'end-time') {
                    if (appState.editingRoute) {
                        appState.editingRoute.endAddress = "Localiza√ß√£o via GPS";
                    } else {
                        appState.currentRoute.endAddress = "Localiza√ß√£o via GPS";
                    }
                }
            } else {
                // If element is a button
                const clientBlock = element.closest('.client-block');
                const index = Array.from(document.querySelectorAll('.client-block')).indexOf(clientBlock);
                
                if (type === 'arrival') {
                    timeInput = clientBlock.querySelector('.client-arrival-time');
                    addressElement = clientBlock.querySelector('.client-arrival-address');
                    if (appState.editingRoute) {
                        appState.editingRoute.clients[index].arrivalAddress = "Localiza√ß√£o via GPS";
                    } else {
                        appState.currentRoute.clients[index].arrivalAddress = "Localiza√ß√£o via GPS";
                    }
                } else {
                    timeInput = clientBlock.querySelector('.client-departure-time');
                    addressElement = clientBlock.querySelector('.client-departure-address');
                    if (appState.editingRoute) {
                        appState.editingRoute.clients[index].departureAddress = "Localiza√ß√£o via GPS";
                    } else {
                        appState.currentRoute.clients[index].departureAddress = "Localiza√ß√£o via GPS";
                    }
                }
            }
            
            // Set current time
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const mins = now.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${mins}`;
            timeInput.value = timeStr;
            
            // Update app state
            if (typeof element === 'string') {
                if (element === 'start-time') {
                    if (appState.editingRoute) {
                        appState.editingRoute.startTime = timeStr;
                    } else {
                        appState.currentRoute.startTime = timeStr;
                    }
                } else if (element === 'end-time') {
                    if (appState.editingRoute) {
                        appState.editingRoute.endTime = timeStr;
                    } else {
                        appState.currentRoute.endTime = timeStr;
                    }
                }
            } else {
                const clientBlock = element.closest('.client-block');
                const index = Array.from(document.querySelectorAll('.client-block')).indexOf(clientBlock);
                
                if (type === 'arrival') {
                    if (appState.editingRoute) {
                        appState.editingRoute.clients[index].arrivalTime = timeStr;
                    } else {
                        appState.currentRoute.clients[index].arrivalTime = timeStr;
                    }
                } else {
                    if (appState.editingRoute) {
                        appState.editingRoute.clients[index].departureTime = timeStr;
                    } else {
                        appState.currentRoute.clients[index].departureTime = timeStr;
                    }
                }
            }
            
            // Simulate address
            if (addressElement) {
                addressElement.textContent = "Localiza√ß√£o via GPS";
            }
        }
        
        // Save route data with date check
        function saveRoute() {
            // Collect all client data
            const clientBlocks = document.querySelectorAll('.client-block');
            const route = appState.editingRoute || appState.currentRoute;
            
            clientBlocks.forEach((block, index) => {
                route.clients[index].name = block.querySelector('.client-name').value;
                route.clients[index].address = block.querySelector('.client-address').value;
                route.clients[index].notes = block.querySelector('.service-notes').value;
                route.clients[index].arrivalTime = block.querySelector('.client-arrival-time').value;
                route.clients[index].departureTime = block.querySelector('.client-departure-time').value;
            });
            
            // Update lunch break status
            route.lunchBreak = document.getElementById('lunch-toggle').checked;
            
            // Calculate worked hours
            const start = parseTime(route.startTime);
            const end = parseTime(route.endTime);
            let diff = (end - start + 1440) % 1440; // Handle overnight
            
            // Subtract 1 hour if lunch break was taken
            if (route.lunchBreak) {
                diff = Math.max(0, diff - 60);
            }
            
            route.workedHours = diff;
            
            if (appState.editingRoute) {
                // Update existing route
                localStorage.setItem('routes', JSON.stringify(appState.routes));
                alert("Rota atualizada com sucesso!");
                cancelEdit();
            } else {
                // Check if route for this date already exists
                const dateStr = route.date.toDateString();
                const existingIndex = appState.routes.findIndex(r => 
                    new Date(r.date).toDateString() === dateStr
                );
                
                if (existingIndex >= 0) {
                    showReplaceModal(existingIndex);
                } else {
                    addNewRoute();
                }
            }
        }
        
        // Show modal to replace or discard
        function showReplaceModal(existingIndex) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-title">Rota j√° existente</div>
                    <div class="modal-message">J√° existe uma rota salva para esta data. Deseja substituir?</div>
                    <div class="modal-buttons">
                        <button class="modal-button secondary" onclick="discardRoute(this.parentElement.parentElement.parentElement)">Cancelar</button>
                        <button class="modal-button primary" onclick="replaceRoute(${existingIndex}, this.parentElement.parentElement.parentElement)">Substituir</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Add new route
        function addNewRoute() {
            appState.routes.push({...appState.currentRoute});
            localStorage.setItem('routes', JSON.stringify(appState.routes));
            resetCurrentRoute();
            alert("Rota salva com sucesso!");
            loadHistory();
        }
        
        // Replace existing route
        function replaceRoute(index, modal) {
            appState.routes[index] = {...appState.currentRoute};
            localStorage.setItem('routes', JSON.stringify(appState.routes));
            resetCurrentRoute();
            modal.remove();
            alert("Rota substitu√≠da com sucesso!");
            loadHistory();
        }
        
        // Discard changes
        function discardRoute(modal) {
            modal.remove();
        }
        
        // Reset current route
        function resetCurrentRoute() {
            appState.currentRoute = {
                date: new Date(),
                startTime: '08:00',
                endTime: '17:00',
                lunchBreak: false,
                clients: [],
                startAddress: '',
                endAddress: '',
                workedHours: 0
            };
            document.getElementById('client-blocks').innerHTML = '';
            addClientBlock();
            document.getElementById('lunch-toggle').checked = false;
            document.getElementById('start-time').value = '08:00';
            document.getElementById('end-time').value = '17:00';
            document.getElementById('start-address').textContent = '';
            document.getElementById('end-address').textContent = '';
            appState.editingRoute = null;
        }
        
        // Load history data
        function loadHistory() {
            const historyDaySelect = document.getElementById('history-day-select');
            historyDaySelect.innerHTML = '';
            
            if (appState.routes.length === 0) {
                historyDaySelect.innerHTML = '<option value="">Nenhuma rota registrada</option>';
                document.getElementById('history-details-container').innerHTML = '<div class="no-history">Nenhuma rota registrada</div>';
                return;
            }
            
            // Sort routes by date (newest first)
            const sortedRoutes = [...appState.routes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get unique dates
            const uniqueDates = [...new Set(sortedRoutes.map(route => 
                new Date(route.date).toLocaleDateString('pt-BR')
            ))];
            
            // Populate day selector
            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                historyDaySelect.appendChild(option);
            });
            
            // Show details for the first date
            if (uniqueDates.length > 0) {
                showHistoryDetails();
            }
        }
        
        // Show details for selected day in history
        function showHistoryDetails() {
            const selectedDate = document.getElementById('history-day-select').value;
            const detailsContainer = document.getElementById('history-details-container');
            
            if (!selectedDate) {
                detailsContainer.innerHTML = '<div class="no-history">Selecione uma data</div>';
                return;
            }
            
            const route = appState.routes.find(r => 
                new Date(r.date).toLocaleDateString('pt-BR') === selectedDate
            );
            
            if (!route) {
                detailsContainer.innerHTML = '<div class="no-history">Nenhum dado para este dia</div>';
                return;
            }
            
            const dateStr = new Date(route.date).toLocaleDateString('pt-BR', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            
            const start = parseTime(route.startTime);
            const end = parseTime(route.endTime);
            let totalDiff = (end - start + 1440) % 1440;
            const totalHours = Math.floor(totalDiff / 60);
            const totalMins = totalDiff % 60;
            
            const workedHours = route.workedHours || totalDiff;
            const workedH = Math.floor(workedHours / 60);
            const workedM = workedHours % 60;
            
            let html = `
                <div class="history-details">
                    <div class="history-date-title">
                        <div>${dateStr}</div>
                        <button class="history-delete-btn" onclick="showDeleteConfirm('${new Date(route.date).toISOString()}')">Excluir</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div><strong>In√≠cio:</strong> ${route.startTime} - ${route.startAddress || 'Sem endere√ßo'}</div>
                        <div><strong>Fim:</strong> ${route.endTime} - ${route.endAddress || 'Sem endere√ßo'}</div>
                        <div><strong>Total de horas:</strong> ${totalHours}h ${totalMins.toString().padStart(2, '0')}m</div>
                        <div><strong>Horas trabalhadas:</strong> ${workedH}h ${workedM.toString().padStart(2, '0')}m</div>
                        <div><strong>Almo√ßo:</strong> ${route.lunchBreak ? 'Sim' : 'N√£o'}</div>
                    </div>
            `;
            
            if (route.clients.length > 0) {
                html += `<div style="margin-top: 15px;"><strong>Clientes atendidos:</strong></div>`;
                
                route.clients.forEach(client => {
                    html += `
                        <div class="history-client">
                            <div class="history-client-name">${client.name || 'Cliente sem nome'}</div>
                            <div class="history-client-info">${client.address || 'Sem endere√ßo'}</div>
                            <div class="history-checkpoint">
                                <div class="history-checkpoint-time">Chegada: ${client.arrivalTime}</div>
                                <div class="history-checkpoint-details">
                                    <div class="history-checkpoint-address">${client.arrivalAddress || 'Sem endere√ßo'}</div>
                                </div>
                            </div>
                            <div class="history-checkpoint">
                                <div class="history-checkpoint-time">Sa√≠da: ${client.departureTime}</div>
                                <div class="history-checkpoint-details">
                                    <div class="history-checkpoint-address">${client.departureAddress || 'Sem endere√ßo'}</div>
                                </div>
                            </div>
                            ${client.notes ? `<div class="history-client-notes">${client.notes}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            html += `
                    <button class="history-edit-btn" onclick="editRoute('${new Date(route.date).toISOString()}')">Editar</button>
                </div>
            `;
            
            detailsContainer.innerHTML = html;
        }
        
        // Show delete confirmation modal
        function showDeleteConfirm(dateString) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-title">Confirmar exclus√£o</div>
                    <div class="modal-message">Tem certeza que deseja excluir esta rota?</div>
                    <div class="modal-buttons">
                        <button class="modal-button secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancelar</button>
                        <button class="modal-button danger" onclick="deleteRoute('${dateString}', this.parentElement.parentElement.parentElement)">Excluir</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Delete route
        function deleteRoute(dateString, modal) {
            const date = new Date(dateString);
            const index = appState.routes.findIndex(r => 
                new Date(r.date).getTime() === date.getTime()
            );
            
            if (index >= 0) {
                appState.routes.splice(index, 1);
                localStorage.setItem('routes', JSON.stringify(appState.routes));
                modal.remove();
                loadHistory();
                alert("Rota exclu√≠da com sucesso!");
            }
        }
        
        // Edit route
        function editRoute(dateString) {
            const date = new Date(dateString);
            const index = appState.routes.findIndex(r => 
                new Date(r.date).getTime() === date.getTime()
            );
            
            if (index >= 0) {
                appState.editingRoute = appState.routes[index];
                
                // Clear current blocks
                document.getElementById('client-blocks').innerHTML = '';
                
                // Set basic info
                document.getElementById('start-time').value = appState.editingRoute.startTime;
                document.getElementById('end-time').value = appState.editingRoute.endTime;
                document.getElementById('lunch-toggle').checked = appState.editingRoute.lunchBreak;
                document.getElementById('start-address').textContent = appState.editingRoute.startAddress || '';
                document.getElementById('end-address').textContent = appState.editingRoute.endAddress || '';
                
                // Add client blocks
                appState.editingRoute.clients.forEach(client => {
                    const clientBlocks = document.getElementById('client-blocks');
                    const newBlock = document.createElement('div');
                    newBlock.innerHTML = clientBlockTemplate;
                    clientBlocks.appendChild(newBlock);
                    
                    // Fill client data
                    const lastBlock = clientBlocks.lastElementChild;
                    lastBlock.querySelector('.client-name').value = client.name || '';
                    lastBlock.querySelector('.client-address').value = client.address || '';
                    lastBlock.querySelector('.service-notes').value = client.notes || '';
                    lastBlock.querySelector('.client-arrival-time').value = client.arrivalTime || '10:00';
                    lastBlock.querySelector('.client-departure-time').value = client.departureTime || '11:00';
                    lastBlock.querySelector('.client-arrival-address').textContent = client.arrivalAddress || '';
                    lastBlock.querySelector('.client-departure-address').textContent = client.departureAddress || '';
                });
                
                // Switch to routes tab
                showTab('routes');
            }
        }
        
        // Cancel edit mode
        function cancelEdit() {
            appState.editingRoute = null;
            resetCurrentRoute();
            showTab('history');
        }
        
        // Update hours tab with data
        function updateHoursTab() {
            const daySelect = document.getElementById('day-select');
            const daySummaryContainer = document.getElementById('day-summary-container');
            const statsContainer = document.getElementById('stats-container');
            const monthlyTable = document.getElementById('monthly-table').querySelector('tbody');
            
            // Clear existing data
            daySelect.innerHTML = '';
            monthlyTable.innerHTML = '';
            
            if (appState.routes.length === 0) {
                daySummaryContainer.innerHTML = '<div class="no-history">Nenhuma rota registrada</div>';
                statsContainer.innerHTML = '';
                document.getElementById('monthly-total').textContent = '0h 00m';
                return;
            }
            
            // Sort routes by date (newest first)
            const sortedRoutes = [...appState.routes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get unique dates
            const uniqueDates = [...new Set(sortedRoutes.map(route => 
                new Date(route.date).toLocaleDateString('pt-BR')
            ))];
            
            // Populate day selector
            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                daySelect.appendChild(option);
            });
            
            // Calculate statistics
            const daysWorked = uniqueDates.length;
            const daysWithoutLunch = sortedRoutes.filter(route => !route.lunchBreak).length;
            const totalClients = sortedRoutes.reduce((sum, route) => sum + route.clients.length, 0);
            
            // Calculate total hours
            let totalMinutes = 0;
            sortedRoutes.forEach(route => {
                totalMinutes += route.workedHours || 0;
            });
            
            const avgMinutes = Math.round(totalMinutes / daysWorked);
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = avgMinutes % 60;
            
            // Total hours (including lunch breaks)
            let totalRawMinutes = sortedRoutes.reduce((sum, route) => {
                const start = parseTime(route.startTime);
                const end = parseTime(route.endTime);
                return sum + ((end - start + 1440) % 1440);
            }, 0);
            
            const totalRawHours = Math.floor(totalRawMinutes / 60);
            const totalRawMins = totalRawMinutes % 60;
            
            // Update stats if we have data
            if (daysWorked > 0) {
                statsContainer.innerHTML = `
                    <div class="section">
                        <div class="section-title">Estat√≠sticas</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${daysWorked}</div>
                                <div class="stat-label">Dias trabalhados</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${daysWithoutLunch}</div>
                                <div class="stat-label">Dias sem almo√ßo</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${avgHours}h ${avgMins.toString().padStart(2, '0')}m</div>
                                <div class="stat-label">M√©dia por dia</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalClients}</div>
                                <div class="stat-label">Clientes atendidos</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statsContainer.innerHTML = '';
            }
            
            // Update monthly table
            sortedRoutes.forEach(route => {
                const dateStr = new Date(route.date).toLocaleDateString('pt-BR');
                const workedHours = route.workedHours || 0;
                const workedH = Math.floor(workedHours / 60);
                const workedM = workedHours % 60;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${workedH}h ${workedM.toString().padStart(2, '0')}m</td>
                    <td>${route.lunchBreak ? 'Sim' : 'N√£o'}</td>
                `;
                monthlyTable.appendChild(row);
            });
            
            // Update monthly total
            document.getElementById('monthly-total').textContent = `${totalRawHours}h ${totalRawMins.toString().padStart(2, '0')}m`;
            
            // Update day summary
            updateDaySummary();
        }
        
        // Update day summary when day is selected
        function updateDaySummary() {
            const daySelect = document.getElementById('day-select');
            const selectedDate = daySelect.value;
            const daySummaryContainer = document.getElementById('day-summary-container');
            
            const route = appState.routes.find(r => 
                new Date(r.date).toLocaleDateString('pt-BR') === selectedDate
            );
            
            if (!route) {
                daySummaryContainer.innerHTML = '<div class="no-history">Nenhum dado para este dia</div>';
                return;
            }
            
            const start = parseTime(route.startTime);
            const end = parseTime(route.endTime);
            let totalDiff = (end - start + 1440) % 1440;
            const totalHours = Math.floor(totalDiff / 60);
            const totalMins = totalDiff % 60;
            
            // Worked hours already accounts for lunch break
            const workedHours = route.workedHours || totalDiff;
            const workedH = Math.floor(workedHours / 60);
            const workedM = workedHours % 60;
            
            daySummaryContainer.innerHTML = `
                <div class="day-summary">
                    <div>Total de horas do dia</div>
                    <div class="day-total">${totalHours}h ${totalMins.toString().padStart(2, '0')}m</div>
                    <div class="lunch-status">${route.lunchBreak ? 'Com pausa para almo√ßo (-1h)' : 'Sem pausa para almo√ßo'}</div>
                    <div style="margin-top: 10px;">Horas trabalhadas: ${workedH}h ${workedM.toString().padStart(2, '0')}m</div>
                </div>
            `;
        }
        
        // Helper function to parse time string to minutes
        function parseTime(timeStr) {
            const [hours, mins] = timeStr.split(':').map(Number);
            return hours * 60 + mins;
        }
        
        // Update current date display
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            const dateStr = now.toLocaleDateString('pt-BR', options);
            document.querySelector('.date-display').textContent = dateStr;
            appState.currentRoute.date = now;
        }
    </script>
</body>
</html>